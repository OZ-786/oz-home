<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>WaliTech | Historical Chart</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- VARIABLES & LAYOUT --- */
        :root { --bg: #0f172a; --panel: #1e293b; --border: #334155; --text: #e2e8f0; --accent: #2563eb; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        #header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: var(--panel); border-bottom: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 20; }
        .brand { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        select#sheetSelector { background: var(--bg); color: white; border: 1px solid var(--border); padding: 8px; border-radius: 6px; outline: none; }

        /* --- CHART AREA --- */
        #chart-wrapper { flex: 1; position: relative; display: flex; flex-direction: column; }
        #stats-bar { height: 50px; background: rgba(30, 41, 59, 0.5); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-around; font-size: 0.85rem; padding: 0 10px; overflow-x: auto; white-space: nowrap; }
        .stat-item { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
        .stat-val { font-weight: 700; font-family: monospace; }
        
        #chart-container { flex: 1; position: relative; padding: 10px; min-height: 0; }
        #main-chart { width: 100%; height: 100%; }

        /* --- CONTROLS --- */
        #controls { background: var(--panel); border-top: 1px solid var(--border); padding: 10px; z-index: 20; }
        .toggle-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 8px; }
        .param-btn { background: transparent; border: 1px solid var(--border); color: #94a3b8; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .param-btn.active { border-color: transparent; color: white; box-shadow: 0 0 10px rgba(0,0,0,0.3); transform: scale(1.05); }
        .footer-tools { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #94a3b8; }

        /* --- OVERLAYS --- */
        .loading-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; pointer-events: none; }
        
        .zoom-buttons { position: absolute; top: 10px; right: 20px; display: flex; gap: 4px; z-index: 10; }
        .zoom-btn { background: rgba(30, 41, 59, 0.9); border: 1px solid var(--border); color: #94a3b8; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; cursor: pointer; }
        .zoom-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Switch Toggle */
        .switch-wrapper { display: flex; align-items: center; gap: 8px; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }
    </style>

    <script>
        // *** CONFIGURATION ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxH13m5DXcyBH2BZ0qp1H3GovZCXEDRbjnD5yzj_KZL3O_MAGXG9PKu8dQdyDHhX0Vi_A/exec";
        
        var chart = null;
        var currentSheetName = "";
        var latestSheetName = "";
        var allData = [];
        var currentZoomHours = 24;
        var isChartLoading = false;
        var liveSyncInterval = null;
        var lastDate = 0;

        // Series Config (Only Voltage visible default)
        var seriesConfig = [
            { id:0, name: 'Voltage', key: 'vol', unit: 'V',   color: '#3b82f6', visible: true,  icon: 'fa-bolt' },
            { id:1, name: 'Current', key: 'cur', unit: 'A',   color: '#a855f7', visible: false, icon: 'fa-flux-capacitor' },
            { id:2, name: 'Power',   key: 'pow', unit: 'W',   color: '#f97316', visible: false, icon: 'fa-plug' },
            { id:3, name: 'Freq',    key: 'freq',unit: 'Hz',  color: '#14b8a6', visible: false, icon: 'fa-wave-square' },
            { id:4, name: 'PF',      key: 'pf',  unit: '',    color: '#6366f1', visible: false, icon: 'fa-percent' },
            { id:5, name: 'Temp',    key: 'temp',unit: '°C',  color: '#ef4444', visible: false, icon: 'fa-temperature-half' },
            { id:6, name: 'Energy',  key: 'eng', unit: 'kWh', color: '#eab308', visible: false, icon: 'fa-battery-full' },
            { id:7, name: 'Cost',    key: 'cost',unit: '₦',   color: '#22c55e', visible: false, icon: 'fa-coins' } 
        ];

        $(document).ready(function () { initApp(); });

        function initApp() {
            setLoading(true, "Connecting...");
            renderButtons();
            createZoomButtons();
            
            $.ajax({
                url: `${GOOGLE_SCRIPT_URL}?action=getDashboardState`,
                dataType: 'json',
                timeout: 25000, 
                success: function(res) {
                    if(res.success && res.sheets.length > 0) {
                        populateSheetSelector(res.sheets);
                        latestSheetName = res.sheets[0];
                        loadChartData(res.sheets[0]);
                    } else {
                        showError("No data found.");
                        setLoading(false);
                    }
                },
                error: function(e) { showError("Connection Failed."); setLoading(false); }
            });
        }

        function createZoomButtons() {
            const container = document.createElement('div');
            container.className = 'zoom-buttons';
            
            // Full Zoom Range
            const zooms = [
                {h:1,l:'1H'}, {h:3,l:'3H'}, {h:6,l:'6H'}, {h:12,l:'12H'}, 
                {h:24,l:'1D'}, {h:72,l:'3D'}, {h:168,l:'1W'}, {h:720,l:'1M'}
            ];

            zooms.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = `zoom-btn ${opt.h === 24 ? 'active' : ''}`;
                btn.textContent = opt.l;
                btn.onclick = () => setZoom(opt.h, btn);
                container.appendChild(btn);
            });
            document.getElementById('chart-container').appendChild(container);
        }

        function setZoom(hours, btn) {
            currentZoomHours = hours;
            document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (allData.length > 0) updateChartWithData(allData);
        }

        function renderButtons() {
            const container = document.getElementById('toggle-container');
            container.innerHTML = '';
            
            const hideBtn = document.createElement('button');
            hideBtn.className = 'param-btn';
            hideBtn.style.borderColor = '#ef4444';
            hideBtn.style.color = '#ef4444';
            hideBtn.innerHTML = `<i class="fa-solid fa-eye-slash"></i> Hide All`;
            hideBtn.onclick = hideAllSeries;
            container.appendChild(hideBtn);

            seriesConfig.forEach((s, idx) => {
                const btn = document.createElement('button');
                btn.id = `btn-${idx}`; 
                btn.className = `param-btn ${s.visible ? 'active' : ''}`;
                btn.style.backgroundColor = s.visible ? s.color : 'transparent';
                btn.style.borderColor = s.visible ? 'transparent' : '#334155';
                btn.style.color = s.visible ? 'white' : '#94a3b8';
                btn.innerHTML = `<i class="fa-solid ${s.icon}"></i> ${s.name}`;
                btn.onclick = () => toggleSeries(idx, btn);
                container.appendChild(btn);
            });
        }

        function populateSheetSelector(sheets) {
            const sel = document.getElementById('sheetSelector');
            sel.innerHTML = "";
            sheets.forEach(s => { let o = document.createElement('option'); o.value = s; o.text = s; sel.appendChild(o); });
            sel.onchange = (e) => loadChartData(e.target.value);
        }

        function loadChartData(sheetName) {
            if(isChartLoading) return;
            isChartLoading = true;
            currentSheetName = sheetName;
            setLoading(true, `Loading ${sheetName}...`);
            document.getElementById('no-data-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';

            if(chart) { chart.destroy(); chart = null; }
            allData = [];
            lastDate = 0;

            $.ajax({
                url: `${GOOGLE_SCRIPT_URL}?action=getMonthData&sheet=${encodeURIComponent(sheetName)}`,
                dataType: 'json', timeout: 60000,
                success: function(res) {
                    try {
                        if (!res.success) { showError(res.error); return; }
                        if (!res.data || res.data.length === 0) {
                            document.getElementById('no-data-message').style.display = 'block';
                            return;
                        }
                        
                        allData = res.data.map(d => {
                            let clean = { ts: (typeof d.ts === 'string' ? parseCustomDate(d.ts) : d.ts) };
                            seriesConfig.forEach(s => { if(d[s.key] !== undefined) clean[s.key] = Number(d[s.key]); });
                            return clean;
                        }).sort((a, b) => a.ts - b.ts);

                        if (allData.length > 0) {
                            lastDate = allData[allData.length - 1].ts;
                        }

                        updateChartWithData(allData);
                        startLiveSync();
                    } catch(e) { showError("Data Error"); }
                },
                error: function(e) { showError("Load Failed."); },
                complete: function() { setLoading(false); isChartLoading = false; }
            });
        }

        // --- CHART RENDER ENGINE ---
        function updateChartWithData(data) {
            if(!data || data.length === 0) return;

            const latestTs = data[data.length - 1].ts;
            const cutoff = latestTs - (currentZoomHours * 3600 * 1000);
            const filtered = data.filter(x => x.ts > cutoff);
            
            updateStats(filtered);

            // Off-Grid Detection (>11 mins gap)
            const annotations = [];
            for(let i=1; i<filtered.length; i++) {
                if(filtered[i].ts - filtered[i-1].ts > 11 * 60 * 1000) {
                    annotations.push({
                        x: filtered[i-1].ts,
                        x2: filtered[i].ts,
                        fillColor: '#ef4444',
                        opacity: 0.3,
                        label: { text: 'OFF', style: { color: '#fff', background: '#ef4444', fontSize: '10px' } }
                    });
                }
            }

            const rate = Math.ceil(filtered.length / 800);
            const sampled = filtered.filter((_, i) => i % rate === 0);
            
            const series = [];
            const yAxes = [];
            let activeCount = 0;

            seriesConfig.forEach((cfg) => {
                if (cfg.visible) {
                    series.push({
                        name: cfg.name,
                        data: sampled.map(d => [d.ts, d[cfg.key] || 0]),
                        color: cfg.color,
                        type: 'line'
                    });

                    // --- KEY CHANGE: DYNAMIC SCALE & PRECISION ---
                    yAxes.push({
                        seriesName: cfg.name,
                        show: true,
                        opposite: (activeCount % 2 !== 0),
                        axisTicks: { show: true },
                        axisBorder: { show: true, color: cfg.color },
                        forceNiceScale: true, // Forces "10, 20, 30" intervals
                        tickAmount: 6, // Ensures spaced out ticks
                        labels: { 
                            style: { colors: cfg.color },
                            // NO APPROXIMATION: Always show 2 decimal places
                            formatter: (v) => v.toFixed(2)
                        },
                        title: { text: cfg.unit, style: { color: cfg.color } },
                    });
                    activeCount++;
                }
            });

            if (yAxes.length === 0) yAxes.push({ show: false });

            const options = {
                series: series,
                chart: { type: 'line', height: '100%', background: 'transparent', foreColor: '#94a3b8', animations: { enabled: false }, toolbar: { show: false } },
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                grid: { borderColor: '#334155', strokeDashArray: 4 },
                xaxis: { 
                    type: 'datetime', 
                    tooltip: { enabled: false },
                    axisBorder: { show: false }, axisTicks: { show: false }
                },
                yaxis: yAxes,
                annotations: { xaxis: annotations },
                tooltip: { theme: 'dark', x: { format: 'dd MMM HH:mm' } },
                legend: { show: false }
            };
            
            if (!chart) {
                chart = new ApexCharts(document.querySelector("#main-chart"), options);
                chart.render();
            } else {
                chart.updateOptions(options, true, true); 
            }
        }

        function updateStats(data) {
            const container = document.getElementById('stats-bar');
            container.innerHTML = "";
            seriesConfig.forEach(cfg => {
                if(cfg.visible) {
                    let max = -999999;
                    data.forEach(d => {
                        let val = d[cfg.key];
                        if(val !== undefined && val > max) max = val;
                    });
                    if(max > -999999) {
                        let div = document.createElement('div');
                        div.className = 'stat-item';
                        div.innerHTML = `<span class="stat-label" style="color:${cfg.color}">${cfg.name}</span><span class="stat-val" style="color:${cfg.color}">${max.toFixed(2)} <span style="font-size:0.7em; opacity:0.7">${cfg.unit}</span></span>`;
                        container.appendChild(div);
                    }
                }
            });
        }

        function toggleSeries(index, btn) {
            const cfg = seriesConfig[index];
            cfg.visible = !cfg.visible;
            btn.classList.toggle('active');
            btn.style.backgroundColor = cfg.visible ? cfg.color : 'transparent';
            btn.style.borderColor = cfg.visible ? 'transparent' : '#334155';
            btn.style.color = cfg.visible ? 'white' : '#94a3b8';
            if (allData.length > 0) updateChartWithData(allData);
        }

        function hideAllSeries() {
            seriesConfig.forEach((cfg, idx) => {
                cfg.visible = false;
                const btn = document.getElementById(`btn-${idx}`);
                if(btn) { btn.classList.remove('active'); btn.style.backgroundColor = 'transparent'; btn.style.borderColor = '#334155'; btn.style.color = '#94a3b8'; }
            });
            // Show Voltage by default
            toggleSeries(0, document.getElementById('btn-0'));
        }

        function startLiveSync() {
            if (liveSyncInterval) clearInterval(liveSyncInterval);
            if (currentSheetName === latestSheetName && document.getElementById("liveToggle").checked) {
                liveSyncInterval = setInterval(liveSync, 15000);
            }
        }

        function liveSync() {
            if (!document.getElementById("liveToggle").checked || isChartLoading || currentSheetName !== latestSheetName) return;
            
            $.getJSON(`${GOOGLE_SCRIPT_URL}?action=getDashboardState`, function(res) {
                if(res.success && res.latest) {
                    const l = res.latest;
                    const serverTs = parseCustomDate(l.ts);

                    // STRICT CHECK: Only update if server time is newer
                    if (serverTs > lastDate) {
                        lastDate = serverTs;
                        allData.push({ ts: serverTs, temp: l.temp, vol: l.vol, cur: l.cur, pow: l.pow, freq: l.freq, pf: l.pf, eng: l.monthEng, cost: l.monthCost });
                        if (allData.length > 15000) allData = allData.slice(-15000);
                        updateChartWithData(allData);
                    }
                }
            });
        }

        // Helper to parse "yyyy/MM/dd HH:mm:ss"
        function parseCustomDate(dateStr) {
            if(typeof dateStr !== 'string') return new Date().getTime();
            const parts = dateStr.split(/[\s\/:]/); 
            if(parts.length >= 6) {
                return new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4], parts[5]).getTime();
            }
            return new Date().getTime();
        }

        function setLoading(state, msg) {
            document.getElementById('loader').style.display = state ? 'flex' : 'none';
            if(msg) document.getElementById('loader-text').innerText = msg;
        }
        function showError(msg) {
            document.getElementById('error-message').innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i><br>${msg}`;
            document.getElementById('error-message').style.display = 'block';
        }
    </script>
</head>
<body>
    <div id="loader" class="loading-overlay"><div class="spinner"></div><p id="loader-text" style="margin-top:15px; color:#cbd5e1; font-size:0.9rem;">Loading...</p></div>

    <div id="header">
        <div class="brand"><a href="index.html" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-chevron-left"></i><span>WaliTech | Historical Chart</span></a></div>
        <select id="sheetSelector"><option>Loading...</option></select>
    </div>

    <div id="chart-wrapper">
        <div id="stats-bar"></div>
        <div id="chart-container">
            <div id="main-chart"></div>
            <div id="no-data-message" class="status-msg"><i class="fa-regular fa-folder-open fa-3x" style="margin-bottom:10px; opacity:0.5;"></i><br>No Data Available</div>
            <div id="error-message" class="status-msg"></div>
        </div>
    </div>

    <div id="controls">
        <div id="toggle-container" class="toggle-group"></div>
        <div class="footer-tools">
            <div class="switch-wrapper"><label class="switch"><input type="checkbox" id="liveToggle" checked><span class="slider"></span></label><span>Live Sync</span></div>
            <span style="opacity:0.5;">v3.2</span>
        </div>
    </div>
</body>
</html>